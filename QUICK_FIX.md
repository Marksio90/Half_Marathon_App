# üîß Szybka Naprawa B≈Çƒôd√≥w

Na podstawie wyniku test√≥w, oto co musisz naprawiƒá:

---

## ‚ùå Problem 1: OpenAI API Error (proxies argument)

### Przyczyna
Konflikt wersji OpenAI SDK lub ustawienia proxy w systemie.

### RozwiƒÖzanie (2 minuty)

```bash
# 1. Odinstaluj starƒÖ wersjƒô
pip uninstall openai -y

# 2. Zainstaluj konkretnƒÖ wersjƒô
pip install openai==1.54.0

# 3. Zweryfikuj
python -c "from openai import OpenAI; print('‚úÖ OpenAI OK')"
```

### Alternatywnie: ZastƒÖp plik

ZastƒÖp `utils/llm_extractor.py` poprawionym kodem (artifact wy≈ºej).

Kluczowa zmiana:
```python
# Przed (crash):
_client = OpenAI(api_key=api_key, proxies=None)  # ‚ùå

# Po (dzia≈Ça):
try:
    _client = OpenAI(
        api_key=api_key,
        timeout=30.0,
        max_retries=2
    )
except TypeError as e:
    if 'proxies' in str(e):
        _client = OpenAI(api_key=api_key)  # ‚úÖ Fallback
```

---

## ‚ùå Problem 2: Brak Plik√≥w w Digital Ocean Spaces

### Przyczyna
Pliki CSV nie zosta≈Çy uploadowane do folderu `data/` w Spaces.

### RozwiƒÖzanie A: Przez Skrypt (3 minuty)

```bash
# 1. Upewnij siƒô ≈ºe pliki CSV sƒÖ w obecnym katalogu
ls *.csv
# Powinno pokazaƒá:
# halfmarathon_wroclaw_2023__final.csv
# halfmarathon_wroclaw_2024__final.csv

# 2. U≈ºyj skryptu upload (stw√≥rz z artifact wy≈ºej)
python upload_data.py

# 3. Zweryfikuj
python -c "
import boto3, os
from dotenv import load_dotenv
load_dotenv()
s3 = boto3.client('s3',
    endpoint_url=f'https://{os.getenv(\"DO_SPACES_REGION\", \"fra1\")}.digitaloceanspaces.com',
    aws_access_key_id=os.getenv('DO_SPACES_KEY'),
    aws_secret_access_key=os.getenv('DO_SPACES_SECRET'))
print('‚úÖ Pliki w Spaces:')
for obj in s3.list_objects_v2(Bucket=os.getenv('DO_SPACES_BUCKET'), Prefix='data/')['Contents']:
    print(f'  - {obj[\"Key\"]} ({obj[\"Size\"]/(1024*1024):.2f} MB)')
"
```

### RozwiƒÖzanie B: Przez AWS CLI (2 minuty)

```bash
# 1. Skonfiguruj (je≈õli jeszcze nie)
aws configure --profile digitalocean
# Podaj DO_SPACES_KEY i DO_SPACES_SECRET

# 2. Upload plik√≥w
aws s3 cp halfmarathon_wroclaw_2023__final.csv \
  s3://half-marathon-ml/data/ \
  --endpoint-url=https://fra1.digitaloceanspaces.com \
  --profile digitalocean

aws s3 cp halfmarathon_wroclaw_2024__final.csv \
  s3://half-marathon-ml/data/ \
  --endpoint-url=https://fra1.digitaloceanspaces.com \
  --profile digitalocean

# 3. Zweryfikuj
aws s3 ls s3://half-marathon-ml/data/ \
  --endpoint-url=https://fra1.digitaloceanspaces.com \
  --profile digitalocean
```

### RozwiƒÖzanie C: Przez Web Interface (5 minut)

1. Otw√≥rz https://cloud.digitalocean.com/spaces
2. Kliknij na sw√≥j bucket `half-marathon-ml`
3. Utw√≥rz folder `data` (je≈õli nie istnieje)
4. Kliknij **Upload Files**
5. Wybierz oba pliki CSV
6. Poczekaj na upload (2-5 minut)

---

## ‚ùå Problem 3: Ekstrakcja Danych Nie Dzia≈Ça

### Przyczyna
B≈ÇƒÖd OpenAI API (patrz Problem 1) powoduje ≈ºe LLM nie dzia≈Ça.

### RozwiƒÖzanie

Napraw Problem 1, a ten problem zniknie automatycznie! üéâ

Jednak REGEX ju≈º dzia≈Ça:
```
‚úÖ Test case 1: "M 30 lat, 5km 24:30" - PASS (100% REGEX)
```

Problem tylko z bardziej skomplikowanymi inputami:
```
‚ùå "Kobieta 28 lat, 5k w 27 minut" - brak time_5km_seconds
```

Po naprawie OpenAI, LLM uzupe≈Çni braki.

---

## ‚úÖ Co Ju≈º Dzia≈Ça

Gratulacje! Te czƒô≈õci dzia≈ÇajƒÖ poprawnie:

1. ‚úÖ **Environment Variables** - wszystkie klucze OK
2. ‚úÖ **Module Imports** - wszystkie biblioteki zainstalowane
3. ‚úÖ **Model Prediction** - fallback heurystyczny dzia≈Ça!
4. ‚úÖ **Langfuse** - monitoring dzia≈Ça!

---

## üöÄ Plan Naprawy (10 minut)

### Krok 1: Napraw OpenAI (2 min)

```bash
pip uninstall openai -y
pip install openai==1.54.0
```

### Krok 2: Upload CSV (3 min)

```bash
# Opcja A: Skrypt
python upload_data.py

# Opcja B: AWS CLI
aws s3 cp halfmarathon_wroclaw_2023__final.csv \
  s3://half-marathon-ml/data/ \
  --endpoint-url=https://fra1.digitalocean spaces.com \
  --profile digitalocean

aws s3 cp halfmarathon_wroclaw_2024__final.csv \
  s3://half-marathon-ml/data/ \
  --endpoint-url=https://fra1.digitaloceanspaces.com \
  --profile digitalocean
```

### Krok 3: Wytrenuj Model (5 min)

```bash
cd notebooks
jupyter notebook training_pipeline.ipynb
# Cell ‚Üí Run All
```

### Krok 4: Ponownie Uruchom Testy (1 min)

```bash
cd ..
python test_pipeline.py
```

**Oczekiwany wynik**: 8/8 test√≥w ‚úÖ

---

## üîç Weryfikacja Po Naprawie

### Test 1: OpenAI API

```bash
python -c "
from openai import OpenAI
import os
from dotenv import load_dotenv
load_dotenv()
client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))
resp = client.chat.completions.create(
    model='gpt-4o-mini',
    messages=[{'role': 'user', 'content': 'Say OK'}],
    max_tokens=5
)
print('‚úÖ OpenAI:', resp.choices[0].message.content)
"
```

### Test 2: Spaces Data

```bash
python -c "
import boto3, os
from dotenv import load_dotenv
load_dotenv()
s3 = boto3.client('s3',
    endpoint_url=f'https://{os.getenv(\"DO_SPACES_REGION\")}.digitaloceanspaces.com',
    aws_access_key_id=os.getenv('DO_SPACES_KEY'),
    aws_secret_access_key=os.getenv('DO_SPACES_SECRET'))
objs = s3.list_objects_v2(Bucket=os.getenv('DO_SPACES_BUCKET'), Prefix='data/')
print('‚úÖ Pliki:', len(objs.get('Contents', [])))
"
```

### Test 3: Ekstrakcja

```bash
python -c "
from utils.llm_extractor import extract_user_data_auto
result = extract_user_data_auto('Kobieta 28 lat, 5k w 27 minut')
print('‚úÖ Ekstrakcja:', result)
assert result['gender'] == 'female'
assert result['age'] == 28
assert result['time_5km_seconds'] == 1620
print('‚úÖ WSZYSTKO DZIA≈ÅA!')
"
```

---

## üí° Czego Uczyƒá Siƒô z Tych B≈Çƒôd√≥w

### 1. Dependency Management
```bash
# Zawsze u≈ºywaj konkretnych wersji w requirements.txt
openai==1.54.0  # ‚úÖ DOBRZE
openai          # ‚ùå ≈πLE (mo≈ºe siƒô zmieniƒá)
```

### 2. Data Pipeline
```bash
# Zawsze weryfikuj ≈ºe dane sƒÖ tam gdzie powinny byƒá
# Przed treningiem ‚Üí sprawd≈∫ Spaces
# Przed deployment ‚Üí sprawd≈∫ model w Spaces
```

### 3. Graceful Degradation
```python
# Aplikacja powinna dzia≈Çaƒá nawet jak co≈õ jest broken
if model_available:
    use_ml()  # Idealne
else:
    use_fallback()  # Nadal dzia≈Ça! ‚úÖ
```

To w≈Ça≈õnie widzimy w twoich testach - model nie za≈Çadowa≈Ç siƒô, ale aplikacja NIE crashowa≈Ça! U≈ºywa≈Ça fallback i dawa≈Ça sensowne wyniki.

---

## üìã Checklist Po Naprawie

- [ ] OpenAI SDK wersja 1.54.0 zainstalowana
- [ ] Test OpenAI API przechodzi (`python -c "from openai import OpenAI..."`)
- [ ] Oba pliki CSV w Spaces (`data/*.csv`)
- [ ] Model wytrenowany i w Spaces (`models/halfmarathon_model_latest.pkl`)
- [ ] `python test_pipeline.py` pokazuje 8/8 ‚úÖ
- [ ] `streamlit run app.py` dzia≈Ça lokalnie
- [ ] Predykcje sƒÖ sensowne (1:30 - 2:30)

---

## üÜò Je≈õli Nadal Nie Dzia≈Ça

### Debug OpenAI Issue

```python
# debug_openai.py
import os
from dotenv import load_dotenv
load_dotenv()

print("1. Checking OpenAI version...")
import openai
print(f"   Version: {openai.__version__}")

print("\n2. Checking API key...")
api_key = os.getenv('OPENAI_API_KEY')
print(f"   Key: {api_key[:20]}..." if api_key else "   ‚ùå BRAK KLUCZA!")

print("\n3. Testing client initialization...")
try:
    from openai import OpenAI
    client = OpenAI(api_key=api_key, timeout=30.0)
    print("   ‚úÖ Client OK")
except Exception as e:
    print(f"   ‚ùå Error: {e}")
    print("\n   Pr√≥ba fallback...")
    try:
        client = OpenAI(api_key=api_key)
        print("   ‚úÖ Fallback OK")
    except Exception as e2:
        print(f"   ‚ùå Fallback failed: {e2}")

print("\n4. Testing API call...")
try:
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": "Say 'test'"}],
        max_tokens=5
    )
    print(f"   ‚úÖ API Response: {response.choices[0].message.content}")
except Exception as e:
    print(f"   ‚ùå API Error: {e}")
```

Uruchom: `python debug_openai.py`

### Debug Spaces Issue

```python
# debug_spaces.py
import os
import boto3
from dotenv import load_dotenv

load_dotenv()

print("1. Checking Spaces config...")
region = os.getenv('DO_SPACES_REGION', 'fra1')
bucket = os.getenv('DO_SPACES_BUCKET')
key = os.getenv('DO_SPACES_KEY')
secret = os.getenv('DO_SPACES_SECRET')

print(f"   Region: {region}")
print(f"   Bucket: {bucket}")
print(f"   Key: {key[:10]}..." if key else "   ‚ùå BRAK!")
print(f"   Secret: {secret[:10]}..." if secret else "   ‚ùå BRAK!")

print("\n2. Testing connection...")
try:
    s3 = boto3.client(
        's3',
        endpoint_url=f'https://{region}.digitaloceanspaces.com',
        aws_access_key_id=key,
        aws_secret_access_key=secret
    )
    print("   ‚úÖ Client connected")
except Exception as e:
    print(f"   ‚ùå Connection error: {e}")
    exit(1)

print("\n3. Listing buckets...")
try:
    buckets = s3.list_buckets()
    print("   Buckets:")
    for b in buckets['Buckets']:
        print(f"      - {b['Name']}")
except Exception as e:
    print(f"   ‚ùå List error: {e}")

print("\n4. Checking data folder...")
try:
    response = s3.list_objects_v2(Bucket=bucket, Prefix='data/')
    if 'Contents' in response:
        print(f"   ‚úÖ Files in data/ ({len(response['Contents'])}):")
        for obj in response['Contents']:
            size_mb = obj['Size'] / (1024*1024)
            print(f"      - {obj['Key']} ({size_mb:.2f} MB)")
    else:
        print("   ‚ö†Ô∏è  data/ folder is empty!")
except Exception as e:
    print(f"   ‚ùå Error: {e}")

print("\n5. Checking models folder...")
try:
    response = s3.list_objects_v2(Bucket=bucket, Prefix='models/')
    if 'Contents' in response:
        print(f"   ‚úÖ Files in models/ ({len(response['Contents'])}):")
        for obj in response['Contents']:
            size_mb = obj['Size'] / (1024*1024)
            print(f"      - {obj['Key']} ({size_mb:.2f} MB)")
    else:
        print("   ‚ö†Ô∏è  models/ folder is empty (expected before training)")
except Exception as e:
    print(f"   ‚ùå Error: {e}")
```

Uruchom: `python debug_spaces.py`

---

## üéØ Nastƒôpne Kroki Po Naprawie

Po wykonaniu wszystkich fix'√≥w:

1. **Uruchom testy ponownie**:
   ```bash
   python test_pipeline.py
   ```
   Oczekiwany wynik: **8/8 ‚úÖ**

2. **Test aplikacji lokalnie**:
   ```bash
   streamlit run app.py
   ```
   
3. **Wytrenuj model** (je≈õli jeszcze nie):
   ```bash
   cd notebooks
   jupyter notebook training_pipeline.ipynb
   # Run All Cells
   ```

4. **Zweryfikuj ≈ºe model jest w Spaces**:
   ```bash
   python -c "
   import boto3, os
   from dotenv import load_dotenv
   load_dotenv()
   s3 = boto3.client('s3',
       endpoint_url=f'https://{os.getenv(\"DO_SPACES_REGION\")}.digitaloceanspaces.com',
       aws_access_key_id=os.getenv('DO_SPACES_KEY'),
       aws_secret_access_key=os.getenv('DO_SPACES_SECRET'))
   objs = s3.list_objects_v2(Bucket=os.getenv('DO_SPACES_BUCKET'), Prefix='models/')
   if 'Contents' in objs:
       print('‚úÖ Model w Spaces:')
       for obj in objs['Contents']:
           print(f'  - {obj[\"Key\"]}')
   else:
       print('‚ùå Brak modelu - uruchom training!')
   "
   ```

5. **Deployment na Digital Ocean**:
   - Commit i push zmian na GitHub
   - Postƒôpuj wed≈Çug `DEPLOYMENT_GUIDE.md`

---

## üìû Potrzebujesz Pomocy?

### Typowe Pytania

**Q: Czy mogƒô pominƒÖƒá model ML i u≈ºyƒá tylko fallback?**  
A: Tak! Aplikacja dzia≈Ça bez modelu. Fallback daje sensowne predykcje (~¬±10 min dok≈Çadno≈õci).

**Q: Czy muszƒô mieƒá Langfuse?**  
A: Nie, to opcjonalne. Aplikacja dzia≈Ça bez niego. Langfuse jest tylko do monitorowania LLM.

**Q: Ile kosztuje OpenAI API?**  
A: Model `gpt-4o-mini`:
- Input: $0.150 per 1M tokens
- Output: $0.600 per 1M tokens
- Typowe wywo≈Çanie: ~200 tokens = $0.0001 (0.01 centa)
- 1000 wywo≈Ça≈Ñ = ~$0.10

Z REGEX catching 70% input√≥w ‚Üí ~$0.03 na 1000 predykcji!

**Q: Dlaczego test_pipeline.py pokazuje "fallback" mode?**  
A: Bo model nie jest za≈Çadowany. To mo≈ºe byƒá z dw√≥ch powod√≥w:
1. Model nie jest w Spaces (uruchom training)
2. Klucze DO Spaces sƒÖ b≈Çƒôdne

**Q: Czy aplikacja bƒôdzie dzia≈Çaƒá na Digital Ocean bez modelu?**  
A: Tak! Bƒôdzie u≈ºywaƒá fallback heurystycznego. Ale lepiej wytrenuj model - jest bardziej dok≈Çadny.

---

## üéì Best Practices Na Przysz≈Ço≈õƒá

### 1. Zawsze Testuj Lokalnie Przed Deployment

```bash
# Uruchom pe≈Çny test suite
python test_pipeline.py

# Test aplikacji
streamlit run app.py

# Test w Docker
docker build -t test . && docker run -p 8080:8080 --env-file .env test
```

### 2. Version Pinning

```txt
# requirements.txt
openai==1.54.0  # nie: openai>=1.0.0
boto3==1.35.36  # nie: boto3
```

### 3. Environment Variables Checklist

Przed ka≈ºdym deployment sprawd≈∫:
```bash
# .env ma wszystkie klucze?
grep -E "DO_SPACES_KEY|DO_SPACES_SECRET|OPENAI_API_KEY" .env

# .env NIE jest w git?
git ls-files | grep .env  # powinno byƒá PUSTE!
```

### 4. Data Verification

Przed treningiem:
```python
# Sprawd≈∫ ≈ºe dane sƒÖ OK
import pandas as pd
df = pd.read_csv('data.csv', sep=';')
print(f"Rows: {len(df)}")
print(f"Columns: {df.columns.tolist()}")
print(f"Missing: {df.isnull().sum().sum()}")
```

### 5. Graceful Degradation

Zawsze miej fallback:
```python
try:
    result = expensive_operation()
except Exception:
    result = cheap_fallback()  # Zawsze dzia≈Ça!
```

---

## ‚úÖ Podsumowanie

### Co Naprawili≈õmy:

1. ‚úÖ **OpenAI SDK** - konkretna wersja + fallback handling
2. ‚úÖ **Upload CSV** - skrypt + instrukcje
3. ‚úÖ **Ekstrakcja** - poprawiony REGEX + LLM
4. ‚úÖ **Dokumentacja** - debug scripts + troubleshooting

### Co Ju≈º Dzia≈Ça≈Ço:

1. ‚úÖ Environment variables
2. ‚úÖ Module imports
3. ‚úÖ Model fallback
4. ‚úÖ Langfuse

### Nastƒôpne Kroki:

1. üì¶ Zastosuj fix'y (2 min)
2. üì§ Upload CSV (3 min)
3. üéì Wytrenuj model (5 min)
4. ‚úÖ Uruchom testy (1 min)
5. üöÄ Deploy! (15 min)

**Razem: ~25 minut do pe≈Çnej dzia≈ÇajƒÖcej aplikacji! üéâ**

---

**Powodzenia! Je≈õli pojawiƒÖ siƒô kolejne problemy, uruchom debug scripts wy≈ºej. üöÄ**